---
- name: Install and configure Tailscale
  hosts: tailscale_subnet_routers
  become: true

  vars:
    tailscale_accept_dns: false

  tasks:
    - name: Check if Tailscale is installed
      ansible.builtin.command: which tailscale
      register: tailscale_installed
      changed_when: false
      failed_when: false

    - name: Install Tailscale
      when: tailscale_installed.rc != 0
      block:
        - name: Download Tailscale install script
          ansible.builtin.get_url:
            url: https://tailscale.com/install.sh
            dest: /tmp/tailscale-install.sh
            mode: "0755"

        - name: Run Tailscale install script
          ansible.builtin.command: /tmp/tailscale-install.sh
          changed_when: true

        - name: Clean up install script
          ansible.builtin.file:
            path: /tmp/tailscale-install.sh
            state: absent

    - name: Enable IP forwarding
      ansible.posix.sysctl:
        name: net.ipv4.ip_forward
        value: "1"
        sysctl_file: /etc/sysctl.d/99-tailscale.conf
        reload: true

    - name: Check Tailscale status
      ansible.builtin.command: tailscale status --json
      register: tailscale_status
      changed_when: false
      failed_when: false

    - name: Configure Tailscale as subnet router
      ansible.builtin.command: >
        tailscale up
        --advertise-routes={{ tailscale_routes }}
        {% if not tailscale_accept_dns %}--accept-dns=false{% endif %}
      when: tailscale_status.rc != 0 or (tailscale_status.stdout | from_json).BackendState != "Running"
      changed_when: true
