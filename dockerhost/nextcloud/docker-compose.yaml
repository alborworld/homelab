services:
  nextcloud:
    image: nextcloud:latest
    container_name: NextCloud
    restart: unless-stopped
    ports:
      - 8081:80
    environment:
      - MYSQL_USER=${NEXTCLOUD_MYSQL_USER}
      - MYSQL_PASSWORD=${NEXTCLOUD_MYSQL_PASSWORD}
      - MYSQL_DATABASE=nextcloud
      - MYSQL_HOST=nextcloud-db
      - TZ=Europe/Amsterdam
    volumes:
      - ${VOLUMEDIR}/nextcloud/html:/var/www/html
      - /mnt/Alessandro:/mnt/Alessandro
      - /mnt/CorsiOnline:/mnt/CorsiOnline
    devices:
      - /dev/dri:/dev/dri
    labels:
      # TRAEFIK
      - traefik.enable=true
      - traefik.http.services.nextcloud.loadbalancer.server.port=8081
      # Old Nextcloud router (insecure)
      - traefik.http.routers.nextcloud-insecure.rule=Host(`nextcloud.home.local`)
      - traefik.http.routers.nextcloud-insecure.entrypoints=web
      - traefik.http.routers.nextcloud-insecure.service=nextcloud
      # Nextcloud router (secure)
      - traefik.http.routers.nextcloud.rule=Host(`nextcloud.${LOCAL_DOMAIN}`)
      - traefik.http.routers.nextcloud.entrypoints=websecure
      - traefik.http.routers.nextcloud.service=nextcloud
      - traefik.http.routers.nextcloud.tls=true
      - traefik.http.routers.nextcloud.tls.certresolver=cloudflare
      # HOMEPAGE
      - homepage.group=Utilities
      - homepage.name=NextCloud
      - homepage.icon=nextcloud.png
      - homepage.href=https://nextcloud.${LOCAL_DOMAIN}
      - homepage.description=Personal Cloud Storage
      - homepage.siteMonitor=https://nextcloud.${LOCAL_DOMAIN}
    depends_on:
      - nextcloud-db
    networks:
      - nextcloud_network

  nextcloud-db:
    image: mariadb:11.4
    container_name: NextCloudDb
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=${NEXTCLOUD_MYSQL_PASSWORD}
      - MYSQL_USER=${NEXTCLOUD_MYSQL_USER}
      - MYSQL_PASSWORD=${NEXTCLOUD_MYSQL_PASSWORD}
      - MYSQL_DATABASE=nextcloud
      - TZ=Europe/Amsterdam
    volumes:
      - ${VOLUMEDIR}/nextcloud/database:/var/lib/mysql
    networks:
      - nextcloud_network

  redis:
    image: redis:alpine
    command: redis-server --protected-mode no
    container_name: NextCloudRedis
    restart: unless-stopped
    networks:
      - nextcloud_network

  onlyoffice:
    image: onlyoffice/documentserver
    container_name: OnlyOffice
    restart: unless-stopped
    environment:
      - JWT_ENABLED=true
      - JWT_SECRET=${ONLY_OFFICE_JWT_SECRET}
    ports:
      - 9980:80
    volumes:
      - ${VOLUMEDIR}/nextcloud/logs/onlyoffice:/var/log/onlyoffice
    labels:
      - traefik.enable=true
      - traefik.http.services.onlyoffice.loadbalancer.server.port=9980
      - traefik.http.routers.onlyoffice.rule=Host(`onlyoffice.${LOCAL_DOMAIN}`)
      - traefik.http.routers.onlyoffice.entrypoints=websecure
      - traefik.http.routers.onlyoffice.service=onlyoffice
      - traefik.http.routers.onlyoffice.tls=true
      - traefik.http.routers.onlyoffice.tls.certresolver=cloudflare
    networks:
      - nextcloud_network

networks:
  nextcloud_network:
    driver: bridge
