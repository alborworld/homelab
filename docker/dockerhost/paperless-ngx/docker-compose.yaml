services:
  paperless-ngx:
    image: ghcr.io/paperless-ngx/paperless-ngx:latest
    container_name: Paperless-NGX
    depends_on:
      paperless-ngx-postgres:
        condition: service_started
      paperless-ngx-redis:
        condition: service_started
    environment:
      - USERMAP_UID=${UID}
      - USERMAP_GID=${GID}
      - TZ=Europe/Amsterdam
      - PAPERLESS_REDIS=redis://paperless-ngx-redis:6379
      - PAPERLESS_DBHOST=paperless-ngx-postgres
      - PAPERLESS_DBNAME=${PAPERLESS_NGX_DB_NAME}
      - PAPERLESS_DBUSER=${PAPERLESS_NGX_DB_USER}
      - PAPERLESS_DBPASS=${PAPERLESS_NGX_DB_PASSWORD}
      - PAPERLESS_SECRET_KEY=${PAPERLESS_NGX_SECRET_KEY}
      - PAPERLESS_URL=https://paperless.${LOCAL_DOMAIN}
      - PAPERLESS_ADMIN_USER=${PAPERLESS_NGX_ADMIN_USER}
      - PAPERLESS_ADMIN_PASSWORD=${PAPERLESS_NGX_ADMIN_PASSWORD}
      - PAPERLESS_ADMIN_MAIL=${PAPERLESS_NGX_ADMIN_EMAIL}
      - PAPERLESS_OCR_LANGUAGE=eng
      - PAPERLESS_ENABLE_ALLAUTH=true
      - PAPERLESS_APPS=allauth.socialaccount.providers.openid_connect
      - PAPERLESS_SOCIALACCOUNT_PROVIDERS={"openid_connect":{"SCOPE":["openid","profile","email"],"OAUTH_PKCE_ENABLED":true,"APPS":[{"provider_id":"pocket-id","name":"Pocket-ID","client_id":"${PAPERLESS_NGX_POCKET_ID_CLIENT_ID}","secret":"${PAPERLESS_NGX_POCKET_ID_CLIENT_SECRET}","settings":{"server_url":"https://id.home.alborworld.com"}}]}}
    ports:
      - "8000:8000"
    volumes:
      - ${VOLUMEDIR}/paperless-ngx/data:/usr/src/paperless/data
      - ${PAPERLESS_NGX_DIR}/media:/usr/src/paperless/media
      - ${PAPERLESS_NGX_DIR}/consume:/usr/src/paperless/consume
      - ${PAPERLESS_NGX_DIR}/export:/usr/src/paperless/export
    labels:
      # TRAEFIK
      - traefik.enable=true
      - traefik.http.services.paperless-ngx-dh.loadbalancer.server.port=8000
      - traefik.http.routers.paperless-ngx-dh.rule=Host(`paperless.${LOCAL_DOMAIN}`)
      - traefik.http.routers.paperless-ngx-dh.entrypoints=websecure
      - traefik.http.routers.paperless-ngx-dh.service=paperless-ngx-dh
      - traefik.http.routers.paperless-ngx-dh.tls=true
      - traefik.http.routers.paperless-ngx-dh.tls.certresolver=cloudflare
      # HOMEPAGE
      - homepage.group=Utilities
      - homepage.name=Paperless-ngx
      - homepage.icon=paperless-ngx.png
      - homepage.href=https://paperless.${LOCAL_DOMAIN}
      - homepage.description=Document Management
      - homepage.siteMonitor=https://paperless.${LOCAL_DOMAIN}
    restart: unless-stopped

  paperless-ngx-postgres:
    image: postgres:16-alpine
    container_name: Paperless-NGX-Postgres
    environment:
      - POSTGRES_DB=${PAPERLESS_NGX_DB_NAME}
      - POSTGRES_USER=${PAPERLESS_NGX_DB_USER}
      - POSTGRES_PASSWORD=${PAPERLESS_NGX_DB_PASSWORD}
      - TZ=Europe/Amsterdam
    volumes:
      - ${VOLUMEDIR}/paperless-ngx/postgres:/var/lib/postgresql/data
    restart: unless-stopped

  paperless-ngx-redis:
    image: redis:7-alpine
    container_name: Paperless-NGX-Redis
    volumes:
      - ${VOLUMEDIR}/paperless-ngx/redis:/data
    restart: unless-stopped
